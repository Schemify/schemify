# -----------------------------
# ğŸ— Stage 1: Builder
# -----------------------------
FROM node:23-slim AS builder

ENV HUSKY=0
WORKDIR /app

COPY package*.json ./
RUN npm ci

COPY . .

# âœ… Solo generar Prisma __project_name_camel__ (sin aplicar migraciones)
RUN npx prisma generate --schema=apps/__project_name_kebab__/prisma/schema.prisma

# âœ… Compilar cÃ³digo
RUN npm run build __project_name_kebab__
RUN npm run build proto

# -----------------------------
# ğŸš€ Stage 2: Runtime
# -----------------------------
FROM node:23-slim AS runtime

ARG DATABASE_URL
ENV DATABASE_URL=${DATABASE_URL}

RUN apt-get update -y && apt-get install -y openssl netcat-openbsd

ENV NODE_ENV=production \
    PRISMA_ENGINES_CHECKSUM_IGNORE_MISSING=1

WORKDIR /app

# â”€â”€â”€ Copiar dependencias â”€â”€â”€â”€â”€â”€â”€â”€
COPY --from=builder /app/package*.json ./
COPY --from=builder /app/node_modules ./node_modules

# â”€â”€â”€ Copiar Prisma schema y migraciones â”€â”€â”€â”€â”€â”€â”€â”€
COPY --from=builder /app/apps/__project_name_kebab__/prisma ./prisma
COPY --from=builder /app/node_modules/.prisma ./node_modules/.prisma
COPY --from=builder /app/node_modules/@prisma ./node_modules/@prisma

# â”€â”€â”€ Copiar cÃ³digo compilado â”€â”€â”€â”€â”€â”€â”€â”€
COPY --from=builder /app/dist ./dist

# â”€â”€â”€ Copiar entrypoint â”€â”€â”€â”€â”€â”€â”€â”€
COPY scripts/entrypoint.sh ./entrypoint.sh
RUN chmod +x ./entrypoint.sh

# â”€â”€â”€ Healthcheck â”€â”€â”€â”€â”€â”€â”€â”€
HEALTHCHECK --interval=10s --timeout=3s --start-period=10s --retries=3 \
    CMD nc -z localhost ${SERVICE_PORT} || exit 1

# â”€â”€â”€ Entrypoint â”€â”€â”€â”€â”€â”€â”€â”€
ENTRYPOINT ["./entrypoint.sh"]
